services:
  igloo:
    image: ghcr.io/frostr-org/igloo-server:umbrel-dev@sha256:537a21c960402f12e2157432ca91573d6155a1c17ef88a4a07e42bd839867d2f
    restart: unless-stopped
    environment:
      ADMIN_SECRET: ${APP_PASSWORD:?set by Umbrel}
      SKIP_ADMIN_SECRET_VALIDATION: "true"
      AUTH_ENABLED: "true"
      RATE_LIMIT_ENABLED: "true"
      NODE_ENV: production
      HEADLESS: "false"
      DB_PATH: /app/data/igloo.db
      TRUST_PROXY: "true"
      HOST_NAME: 0.0.0.0
      HOST_PORT: "8002"
      # @self auto-allows the host users actually connect through (LAN IP, Tor onion, custom domain)
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-@self,http://umbrel.local,https://umbrel.local,http://umbrel.local:8002,https://umbrel.local:8002}
    volumes:
      - ${APP_DATA_DIR}:/app/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8002/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  app_proxy:
    # image: ${APP_PROXY_IMAGE:-ghcr.io/getumbrel/umbrel-app-proxy:latest}
    environment:
      APP_HOST: igloo-server_igloo_1
      APP_PORT: "8002"
      PROXY_AUTH_WHITELIST: /api/*,/api/docs/*,/api/events/*
    depends_on:
      - igloo
